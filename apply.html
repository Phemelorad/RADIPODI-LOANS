// ✅ Show logged-in user email
  async function checkSession() {
    const { data, error } = await supabase.auth.getSession();
    const session = data.session;

    if (error || !session) {
      window.location.href = "index.html";
    } else {
      document.getElementById("user-email").textContent = session.user.email;
    }
  }

  // ✅ Logout
  async function logout() {
    await supabase.auth.signOut();
    window.location.href = "index.html";
  }

  // ✅ Submit Application
  async function submitApplication(event) {
    event.preventDefault();

    // Upload ID copy
    const file = document.getElementById("id").files[0];
    if (!file) return alert("Please upload an ID copy.");

    const filename = `${Date.now()}_${file.name}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from("id-copies") // ✅ Make sure bucket is called "id-copies"
      .upload(filename, file);

    if (uploadError) return alert("❌ Upload failed: " + uploadError.message);

    const { data: urlData } = supabase.storage.from("id-copies").getPublicUrl(filename);
    const id_copy_url = urlData.publicUrl;

    // Get applicant data
    const applicant = {
      name: document.getElementById("name").value,
      surname: document.getElementById("surname").value,
      dob: document.getElementById("date").value,
      gender: document.getElementById("gender").value,
      id_number: document.getElementById("omang").value,
      phone1: document.getElementById("phone1").value,
      phone2: document.getElementById("phone2").value,
      email: document.getElementById("email").value,
      address: document.getElementById("address").value,
      id_copy_url
    };

    const employment = {
      status: document.getElementById("es").value,
      occupation: document.getElementById("occupation").value,
      work_phone: document.getElementById("work").value
    };

    const loan = {
      loan_amount: parseFloat(document.getElementById("amount").value),
      repayment_months: parseInt(document.getElementById("repayment").value),
      bank_account: document.getElementById("bad").value
    };

    const guarantor = {
      name: document.getElementById("gname").value,
      surname: document.getElementById("gsurname").value,
      phone: document.getElementById("gphone").value
    };

    // Insert applicant
    const { data: applicantData, error: applicantError } = await supabase
      .from("applicants")
      .insert([applicant])
      .select("applicant_id")
      .single();

    if (applicantError) return alert("❌ Applicant save failed: " + applicantError.message);
    const applicant_id = applicantData.applicant_id;

    // Insert into related tables
    const { error: empErr } = await supabase.from("employment").insert([{ applicant_id, ...employment }]);
    const { error: loanErr } = await supabase.from("loan_applications").insert([{ applicant_id, ...loan }]);
    const { error: guarErr } = await supabase.from("guarantors").insert([{ applicant_id, ...guarantor }]);

    if (empErr || loanErr || guarErr) {
      return alert("❌ One of the inserts failed: " + (empErr?.message || loanErr?.message || guarErr?.message));
    }

    alert("✅ Application submitted successfully!");
    document.querySelector("form").reset();
  }

  // ✅ Init on page load
  checkSession();
</script>
